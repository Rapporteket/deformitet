---
title: 'Startside'
author: 'Ingrid Bondevik'
date: '`r format(Sys.time(), "%d. %B %Y")`'
output: 
  html_document: 
    keep_md: yes
---


# Rapporteket for Deformitet

### Om Rapporteket:
Velkommen til Rapporteket for Deformitetsregisteret. I rapporteket er det mulig å se figurer og tabeller med oppdaterte data, samt å laste ned og abonnere på rapporter der figurer og tabeller er inkludert.  
Dersom du ikke tilhører registerledelsen vil figurene sammenligne din enhet med resten av landet. Det vil si at det ikke er mulig å se tall for hver enkelt av de andre enhetene.

### Om registeret:
Deformitetsregisteret er en del av NKR (Nasjonalt kvalitetsregister for ryggkirurgi). Fra 01.01.23 registreres alle operasjoner for idiopatisk skoliose utført i Norge, uavhengig av pasientens alder. Idiopatisk skoliose er en tilstand som debuterer hos barn og ungdom, og de fleste som opereres gjør dette i tenårene. Kirurgi er omfattende med fare for alvorlige komplikasjoner både på kort og lang sikt. Kirurgi medfører en livsvarig lang avstiving av ryggsøylen med metallimplantater. Det har stor verdi for kvalitetsforbedrende arbeid og forskning at disse pasientene er registrert i et nasjonalt register. Oppfølging med pasientrapporterte data samlet i register er nødvendig for å kunne oppdage endring i livskvalitet og eventuelle komplikasjoner på lang sikt. 
I Norge behandles idiopatisk skoliose ved Haukeland Universitetssjukehus, St.Olavs hospital og Rikshospitalet-OUS. Alle 3 sykehus rapporterer sine operasjoner til registeret. 

Ved inkludering i registeret fyller pasienten ut samtykke og preoperativt skjema. Kirurg fyller ut legeskjema etter operasjon. Pasienter fyller ut skjema postoperativt etter 6 måneder, 2år og 5 år. Dette blir tilsendt og fylles ut elektronisk.
Alle reoperasjoner skal registreres. Dersom pasienter med skoliose opereres for en annen degenerativ rygglidelse (spinal stenose, prolaps etc.) registreres dette i NKR degenerativ, ikke i Deformitet.

### Nøkkeltall:

```{r, include=FALSE, echo=FALSE}
### Read in data:
raw_regdata <- deformitet::les_og_flate_ut()

#### Clean and tidy data:

regdata <- deformitet::pre_pros(raw_regdata)
```


```{r, include=FALSE, echo=FALSE}
#### PER SYKEHUS #####

#Alder, kobbvinkel og antall opererte
age_curve_data <- regdata %>%
  dplyr::filter(!is.na(PRE_MAIN_CURVE)) %>%
  dplyr::group_by(Sykehus, year = lubridate::floor_date(SURGERY_DATE, "year")) %>%
  dplyr::mutate(year = format(year, "%Y")) %>%
  dplyr::filter(year != 2025) %>%
  dplyr::summarize(n_opererte = as.character(dplyr::n_distinct(PID)),
    pre_cobb = as.character(round(mean(PRE_MAIN_CURVE), digits = 0)),
    Alder_median = round(median(Alder_num), digits = 1),
    Alder_range = paste(min(Alder_num), "-", max(Alder_num), sep = "")) %>%
  dplyr::mutate("Alder (median, range)" = paste0(Alder_median, " (", Alder_range, ")")) %>%
  dplyr::select(-c(Alder_median, Alder_range))


# Kjønn
gender_data <- regdata %>%
  dplyr::group_by(Sykehus, year = lubridate::floor_date(SURGERY_DATE, "year")) %>%
  dplyr::mutate(year = format(year, "%Y")) %>%
  dplyr::filter(year != 2025) %>%
  dplyr::count(f = Kjønn == "kvinne") %>%
  dplyr::mutate(total = sum(n)) %>%
  dplyr::filter(f == TRUE) %>%
  dplyr::mutate(pro_kvinne = as.character(round((n / total * 100), digits = 0))) %>%
  dplyr::select(pro_kvinne)

key_data <- dplyr::left_join(age_curve_data, gender_data)


#### NASJONALT ####
# Alder, kobbvinkel og antall opererte
nasjonalt_age_curve_data <- regdata %>%
  dplyr::filter(!is.na(PRE_MAIN_CURVE)) %>%
  dplyr::group_by(year = lubridate::floor_date(SURGERY_DATE, "year")) %>%
  dplyr::mutate(year = format(year, "%Y")) %>%
  dplyr::filter(year != 2025) %>%
  dplyr::summarize(n_opererte = as.character(dplyr::n_distinct(PID)),
    pre_cobb = as.character(round(mean(PRE_MAIN_CURVE), digits = 0)),
    Alder_median = round(median(Alder_num), digits = 1),
    Alder_range = paste(min(Alder_num), "-", max(Alder_num), sep = "")) %>%
  dplyr::mutate("Alder (median, range)" = paste0(Alder_median, " (", Alder_range, ")")) %>%
  dplyr::select(-c(Alder_median, Alder_range))

# Kjønn
nasjonalt_gender_data <- regdata %>%
  dplyr::group_by(year = lubridate::floor_date(SURGERY_DATE, "year")) %>%
  dplyr::mutate(year = format(year, "%Y")) %>%
  dplyr::filter(year != 2025) %>%
  dplyr::count(f =  Kjønn == "kvinne") %>%
  dplyr::mutate(total = sum(n)) %>%
  dplyr::filter(f == TRUE) %>%
  dplyr::mutate(pro_kvinne = as.character(round((n / total * 100), digits = 0))) %>%
  dplyr::select(pro_kvinne)

nasjonalt_key_data <- dplyr::left_join(nasjonalt_age_curve_data, nasjonalt_gender_data) %>%
  dplyr::mutate(Sykehus = "Nasjonalt") %>%
  dplyr::relocate(Sykehus)

## Koble nasjonalt med sykehusvis

key_data <- rbind(key_data, nasjonalt_key_data)
```


```{r, include=FALSE, echo=FALSE}
# Lag tabellen
key_data_table <- key_data %>%
  dplyr::mutate(pro_kvinne = paste(pro_kvinne, "%", sep = ""),
    pre_cobb = paste(pre_cobb, intToUtf8(176), sep = "")) %>% 
  dplyr::rename("År" = "year",
    "Prosentandel kvinner" = pro_kvinne,
    "Preoperativ Cobbvinkel" = pre_cobb,
    "Antall opererte" = n_opererte)

# Få ønsket rekkefølge på Sykehus
key_data_table <- key_data_table %>%
  dplyr::arrange(factor(Sykehus, levels = c("Nasjonalt", "Haukeland", "Rikshospitalet", "St.Olav"))) %>% 
  dplyr::filter(Sykehus == "Nasjonalt") # lagt til denne filtreringen siden reg.leder kun ønsker visning av nasjonalt

```

```{r, echo=FALSE}

key_data_table %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling(bootstrap_options = c("bordered", "responsive", "condensed"))
```

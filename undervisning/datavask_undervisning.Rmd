---
title: "Datavask_HEL8020"
author: "Ingrid Bondevik"
date: "2025-03-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
```


Jeg leser inn dataen
-> jeg har valgt snake_case
```{r}

data <- readRDS("fake_data_deformitet.rds")

data$SURGERY_DATE <- as.numeric(data$SURGERY_DATE)

my_data <- data %>% 
  dplyr::select(c(PID, CENTREID, CENTRESHORTNAME, GENDER, BIRTH_DATE, SURGERY_DATE, PRE_MAIN_CURVE, POST_MAIN_CURVE, SRS22_22, SRS22_22_patient12mths, BMI_CATEGORY))

```

Jeg ser på dataen
```{r}

view(my_data)

```

1. Kolonnenavn: SNAKE_CASE med store bokstaver (vi lar det gå)
1a. Kolonnenavn på SRS22_22 - hva betyr dette? 
2. Ikke fornøyd med sykehusnavnene - Bergen, Riksen, St. Olav
3. Operasjonsdato er ikke i samme format som BIRTH_DATE
4. Alder mangler - jeg må regne ut alder ved operasjonsdato
5. En del manglende verdier - pre og post main curve og SRS22_12mnd


1. Kolonnenavn
```{r}

my_data <- my_data %>% 
  dplyr::rename(Fornoyd = SRS22_22,
                Fornoyd12 = SRS22_22_patient12mths)

```



2. SYKEHUSNAVN
```{r}
my_data %>% 
  select(CENTRESHORTNAME) %>% 
  unique()
```

Vi lager nye navn 
"recode" -> lage nye "navn" på verdiene 
"rename" -> lage nye navn på variablene 
```{r}
my_data <- my_data %>%
  dplyr::mutate(CENTRESHORTNAME = dplyr::recode(CENTRESHORTNAME,
                                                "Bergen" = "Haukeland",
                                                "Riksen" = "Rikshospitalet")) 
```

Fungerte det? 
```{r}

my_data %>% 
  select(CENTRESHORTNAME) %>% 
  unique()

```



3. ENDRE OPERASJONSDATO

Sjekker datatypen:
```{r}
class(my_data$BIRTH_DATE)
class(my_data$SURGERY_DATE)
```

Vi endrer datatypen til SURGERY_DATE:
```{r}

my_data$SURGERY_DATE <- as.Date(my_data$SURGERY_DATE)

# Sjekk
class(my_data$SURGERY_DATE)
head(my_data)


```


4. REGNE UT ALDER
Regner ut alder i år
```{r}
my_data <- my_data %>%
  dplyr::mutate(AGE = (difftime(SURGERY_DATE, BIRTH_DATE,
                            units = "days"))/365.25)

# Sjekk 
my_data %>% 
  select(c(AGE, BIRTH_DATE, SURGERY_DATE)) %>% 
  head()
```

# Endre datatype 
```{r}
my_data$AGE <- as.numeric(my_data$AGE)

# Sjekk på nytt
my_data %>% 
  select(AGE)
```

# Endre datatype på nytt
```{r}
my_data$AGE <- as.integer(my_data$AGE)

# Sjekk enda en gang
my_data %>% 
  select(AGE)
```

# Sjekk enda en gang at det ble rett
```{r}
my_data %>%
  select(AGE, BIRTH_DATE, SURGERY_DATE) %>% 
  head()

view(my_data)

```

5a. Se på manglende verdier på pre og post main curve

# Er det noen sykehus som har flere manglende verdier enn andre sykehus?
```{r}
# Jeg lager nytt datasett med kolonne som sier om det er NA eller ikke i denne observasjonen (NA? ja vs. nei)
my_data_NA <- my_data %>% 
  dplyr::mutate(NA_PRE_MAIN_CURVE = ifelse(is.na(PRE_MAIN_CURVE), "nei", "ja"),
                NA_POST_MAIN_CURVE = ifelse(is.na(POST_MAIN_CURVE), "nei", "ja"))

# Sjekk:
my_data_NA %>% 
  select(PRE_MAIN_CURVE, NA_PRE_MAIN_CURVE, POST_MAIN_CURVE, NA_POST_MAIN_CURVE) %>% 
  print()

# Dette ser feil ut
```

# Jeg har gjort noe feil - jeg gjentar stegene over:

```{r}
# Jeg lager nytt datasett med kolonne som sier om det er NA eller ikke i denne observasjonen (NA? ja vs. nei)
my_data_NA <- my_data %>% 
  dplyr::mutate(NA_PRE_MAIN_CURVE = ifelse(is.na(PRE_MAIN_CURVE), "ja", "nei"),
                NA_POST_MAIN_CURVE = ifelse(is.na(POST_MAIN_CURVE), "ja", "nei"))

# Sjekk:
my_data_NA %>% 
  select(PRE_MAIN_CURVE, NA_PRE_MAIN_CURVE, POST_MAIN_CURVE, NA_POST_MAIN_CURVE) %>% 
  print()
```

Visualisering:
Pre
```{r}
# Jeg lager en enkel oversikt pr sykeshus
## PRE 
my_data_NA %>% 
  ggplot(aes(x = NA_PRE_MAIN_CURVE, fill = CENTRESHORTNAME))+
  geom_bar()
```

Post
```{r}
## POST 
my_data_NA %>% 
  ggplot(aes(x = NA_POST_MAIN_CURVE, fill = CENTRESHORTNAME))+
  geom_bar()

# Spredningen ser jevn ut for hvert sykehus
```

Vi lager en enkel oversikt pr operasjonsdato 
pre
```{r}
my_data_NA %>% 
  ggplot(aes(x = SURGERY_DATE, fill = NA_PRE_MAIN_CURVE, colour = NA_PRE_MAIN_CURVE))+
  geom_dotplot(alpha = .5)
```

post
```{r}
my_data_NA %>% 
  ggplot(aes(x = SURGERY_DATE, fill = NA_POST_MAIN_CURVE, colour = NA_POST_MAIN_CURVE))+
  geom_dotplot(alpha = .5)

# Det er ikke en klar tidstrend

```

5b. Se på manglende verdier på Fornoyd 
Hva er disse verdiene?
Oppfølging 3-6mnd og 12 mnd -> kanskje pasientene ikke har fått oppfølgingsskjemaet enda? 

```{r}

view(my_data)

# Legger til ei kolonne som inneholder dagens dato (den kommer til å være replisert over alle observasjoner)
my_data <- my_data %>% 
  dplyr::mutate(today = Sys.Date()) ### as.Date("2024-10-01")

# Sjekker at det fungerte
my_data %>% 
  head()
```

Nå kan vi sjekke avstand mellom operasjonsdato og dagens dato 
```{r}
my_data <- my_data %>% 
  mutate(lenge_siden = as.integer(difftime(today, SURGERY_DATE, units = "days")))

my_data %>% 
  select(lenge_siden) %>% 
  head()

# Det ser fint ut
```

Lager nye variabler og verdier 
  1. Først sjekke om det er NA eller registrert tall - TRUE FALSE
  2. Gjøre dette til tegn (og ikke logisk verdi)
  3. Endre verdiene fra TRUE (det er sant at det er NA) => mangler // FALSE (det er ikke sant at det er NA) => fylt inn
  4. Hvis det er over 430 dager siden => "lenge", ellers "kort"
```{r}
my_data_NA <- my_data %>% 
  mutate(na_fornoyd12 = as.character(is.na(Fornoyd12)),
         na_fornoyd12 = recode(na_fornoyd12, "TRUE" = "Mangler", "FALSE" = "Fylt inn"),
         tid = ifelse(lenge_siden > 430, "lenge", "kort"))

# Vi sjekker
my_data_NA %>% 
  select(Fornoyd12, na_fornoyd12, lenge_siden, tid) %>% 
  head()

```

Vi plotter
```{r}

my_data_NA %>% 
  ggplot(aes(x = tid, fill = na_fornoyd12))+
  geom_bar()


#  facet_grid(~CENTRESHORTNAME) - legge til for å se pr. sykehus

# Hva foregår her?
# Jo! Datauttrekket var ikke i dag, men i oktober 2024
# Vi kjører samme operasjon på nytt, men setter inn dato: 01.10.2024


```

TA UT OBSERVASJONER
1. Kun inkluder pasienter mellom 15 og 20 år
2. Ekskluder pasienter som er undervektige
3. Ta bort pasienter som er opererte før 1. januar 2024 

Alder 
```{r}
range(my_data$AGE)

my_data_small <- my_data %>% 
  filter(between(AGE, 15, 20))
```


sjekk
```{r}

range(my_data_small$AGE)

```

Vekt 
```{r}

my_data_small %>% 
  ggplot(aes(x = BMI_CATEGORY))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Vi har "Alvorlig undervekt", "Moderat undervekt" og "Mild undervekt" -> alle disse skal ut
```{r}

my_data_small %>% 
  dplyr::count(BMI_CATEGORY)

```
my_data_small = 140 obs
undervekt => 41 skal ut
Vi skal ha 99 observasjoner igjen


```{r}

my_data_small <- my_data_small %>% 
  dplyr::filter(!BMI_CATEGORY %in% c("Alvorlig undervekt", "Moderat undervekt", "Mild undervekt"))


my_data_small %>% 
  dplyr::count(BMI_CATEGORY)

```
Ta bort operasjoner før 01.01.24
```{r}

range(my_data_small$SURGERY_DATE)

my_data_small <- my_data_small %>% 
  dplyr::filter(SURGERY_DATE > "2024-01-01") %>% 
  head()


```


ANALYSE - VISUALISERING 
1. Vi har lyst til å visualisere og sammenligne variablene pre- og postoperativ kurve

Hva må vi gjøre for å få det til? 
-Finne visualiseringsverktøyet vi ønsker å bruke: boxplot (geom_boxplot)
-Da trenger vi én kontinuerlig variabel og én kategorisk variabel
-Vi omstrukturere dataene våre 


```{r}
my_data_curve <- my_data %>% 
  select(PID, CENTRESHORTNAME, PRE_MAIN_CURVE, POST_MAIN_CURVE)
  
view(my_data_curve)
```

Lag datasettet lengre

```{r}
my_data_curve <- my_data_curve %>% 
  pivot_longer(!c(PID, CENTRESHORTNAME), names_to = "Kurve", values_to = "Grader")

# Sjekk 
my_data_curve %>% 
  head()
```


```{r}
# Vi gir nye navn til verdiene 
my_data_curve <- my_data_curve %>% 
  dplyr::mutate(Kurve = dplyr::recode(Kurve, 
                                      "PRE_MAIN_CURVE" = "pre",
                                      "POST_MAIN_CURVE" = "post"))

# Sjekk at det fungerte:
my_data_curve %>% 
  head()
```

Vi plotter

```{r}
# Kategorisk variabel - kurve : pre og post
# Kontinuerlig variabel - grader

my_data_curve %>% 
  ggplot(aes(x = Kurve, y = Grader))+
  geom_boxplot()

```

Litt ryddigere plotting

```{r}
# Litt ryddigere: 
my_data_curve %>% 
  mutate(Kurve = factor(Kurve),
         Kurve = fct_relevel(Kurve, c("pre","post"))) %>%
  ggplot(aes(x = Kurve, y = Grader))+
  geom_boxplot()
```

Vi har ikke gjort noe med manglende verdier her: 
```{r}
### Obs! Her har vi ikke gjort noe med manglende verdier. geom_boxplot() overser bare disse. Hva skjer hvis vi skal ha gjennomsnittet? 

mean(my_data_curve$Grader) # Dette går ikke
```


```{r}
# For å fikse dette må vi ta ut manglende verdier - skal vi da ta ut alle pasienter som har en manglende verdi eller kun observasjonen som har en manglende verdi? 

my_data_curve %>% 
  count(is.na(Grader)) # 42 observasjoner med manglende verdier, 532 med fylte verdier
```


```{r}
my_data_curve_noNA <- my_data_curve %>% # vi forventer at datasettet nå skal ha 532 observasjoner
  filter(is.na(Grader)) 

my_data_curve_noNA %>% 
  count(is.na(Grader))

## Dette ble feil
```


Vi prøver på nytt:
```{r}
my_data_curve_noNA <- my_data_curve %>% # vi forventer at datasettet nå skal ha 532 observasjoner
  filter(!is.na(Grader)) 

# Dette ble rett, men la oss dobbeltsjekke

my_data_curve_noNA %>% 
  count(is.na(Grader)) 



```
```{r}
mean(my_data_curve_noNA$Grader)
```

# Nå kan vi regne ut gjennomsnittet (MEN gjennomsnittet gir jo ingen mening - vi har her gjennomsnittet av kurven pre og post)

Nå kan vi enten dele opp datasettet igjen slik at vi har pre og post i ulike kolonner

```{r}
my_data_curve_noNA %>% 
  pivot_wider(names_from = Kurve, values_from = Grader)

```

